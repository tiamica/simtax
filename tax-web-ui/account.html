<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <title data-i18n="taxAccountOverview">Tax Account Overview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background-color: #007bff;
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin-bottom: 0.5rem;
        }

        .user-info {
            font-size: 1.1rem;
        }

        .current-year {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .current-year h2 {
            color: #007bff;
            margin-bottom: 1.5rem;
        }

        .tax-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .tax-item {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .tax-item .label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .tax-item .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .tax-item.highlight {
            background-color: #e8f4ff;
        }

        .tax-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .tax-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .tax-status.paid {
            background-color: #d4edda;
            color: #155724;
        }

        .tax-status.active {
            background-color: #cce5ff;
            color: #004085;
        }

        .history {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .history h2 {
            color: #007bff;
            margin-bottom: 1.5rem;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .history-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .history-table tr:hover {
            background-color: #f8f9fa;
        }

        .login-section {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 4rem auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            width: 100%;
            padding: 0.8rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .payment-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #dee2e6;
        }

        .payment-section h3 {
            color: #007bff;
            margin-bottom: 1rem;
        }

        .payment-form {
            max-width: 400px;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left {
            flex: 1;
        }

        .logout-btn {
            width: auto;
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .login-divider {
            text-align: center;
            margin: 1rem 0;
            position: relative;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background-color: #ddd;
        }

        .login-divider::before {
            left: 0;
        }

        .login-divider::after {
            right: 0;
        }

        .login-divider span {
            background-color: white;
            padding: 0 10px;
            color: #666;
            font-size: 0.9rem;
        }

        .secondary-btn {
            background-color: #f8f9fa;
            color: #007bff;
            border: 1px solid #007bff;
            margin-top: 0.5rem;
        }

        .secondary-btn:hover {
            background-color: #e8f4ff;
        }

        .app-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }

        .app-header img {
            height: 40px;
            margin-right: 1rem;
        }

        .app-header h1 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        /* Language selector styles */
        .language-selector-container {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .language-selector-container label {
            margin-right: 0.8rem;
            font-weight: 500;
            color: #495057;
        }
        
        .language-selector {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 0.9rem;
            color: #333;
            cursor: pointer;
        }
        
        .language-selector:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        @media (max-width: 768px) {
            .language-selector-container {
                padding: 0.6rem;
                margin-bottom: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Manually add language selector instead of relying on language-switcher.js to create it -->
        <div class="language-selector-container">
            <label for="languageSelector" data-i18n="language">Language:</label>
            <select id="languageSelector" class="language-selector" onchange="updateLanguage(this.value)">
                <option value="en" data-i18n="english">English</option>
                <option value="ig" data-i18n="igbo">Igbo</option>
                <option value="yo" data-i18n="yoruba">Yoruba</option>
                <option value="ha" data-i18n="hausa">Hausa</option>
            </select>
        </div>
        
        <div id="loginSection" class="login-section">
            <div class="app-header">
                <img src="Fourier-Analytics-Logo.png" alt="Fourier Analytics Logo">
                <h1 data-i18n="accountLogin">Account Login</h1>
            </div>
            <div class="form-group">
                <label for="phoneNumber" data-i18n="phoneNumber">Phone Number:</label>
                <input type="text" id="phoneNumber" data-i18n-placeholder="enterPhoneNumber" placeholder="Enter your phone number">
            </div>
            <button onclick="login()" data-i18n="login">Login</button>
            <div class="login-divider">
                <span data-i18n="or">or</span>
            </div>
            <button onclick="showRegistrationForm()" class="secondary-btn" data-i18n="createNewAccount">Create New Account</button>
        </div>

        <div id="registrationSection" class="login-section" style="display: none;">
            <div class="app-header">
                <img src="Fourier-Analytics-Logo.png" alt="Fourier Analytics Logo">
                <h1 data-i18n="registerNewAccount">Register New Account</h1>
            </div>
            <div class="form-group">
                <label for="regPhoneNumber" data-i18n="phoneNumber">Phone Number:</label>
                <input type="text" id="regPhoneNumber" data-i18n-placeholder="enterPhoneNumber" placeholder="Enter your phone number">
            </div>
            <div class="form-group">
                <label for="regTIN" data-i18n="tinLabel">TIN (Tax Identification Number):</label>
                <input type="text" id="regTIN" data-i18n-placeholder="enterTIN" placeholder="Enter your TIN">
            </div>
            <button onclick="register()" data-i18n="register">Register</button>
            <button onclick="showLoginForm()" class="secondary-btn" data-i18n="backToLogin">Back to Login</button>
        </div>

        <div id="accountSection" style="display: none;">
            <div class="app-header">
                <img src="Fourier-Analytics-Logo.png" alt="Fourier Analytics Logo">
                <h1 data-i18n="taxAccountOverview">Tax Account Overview</h1>
            </div>
            <div class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h1 data-i18n="taxAccountOverview">Tax Account Overview</h1>
                        <div class="user-info" id="userInfo"></div>
                    </div>
                    <button onclick="logout()" class="logout-btn" data-i18n="logout">Logout</button>
                </div>
            </div>

            <div class="current-year">
                <div class="year-selector" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 data-i18n="taxSummary">Tax Summary</h2>
                    <select id="yearSelector" onchange="loadAccountData()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
                <div id="currentYearSummary" class="tax-summary">
                    <h3 data-i18n="currentYearSummary">Current Year Summary</h3>
                    <div class="tax-item">
                        <div class="label" data-i18n="year">Year</div>
                        <div class="value" id="currentYear"></div>
                    </div>
                    <div class="tax-item">
                        <div class="label" data-i18n="income">Income</div>
                        <div class="value" id="currentIncome"></div>
                    </div>
                    <div class="tax-item">
                        <div class="label" data-i18n="expenditure">Expenditure</div>
                        <div class="value" id="currentExpenses"></div>
                    </div>
                    <div class="tax-item highlight">
                        <div class="label" data-i18n="totalTaxOwed">Total Tax Owed</div>
                        <div class="value" id="currentTaxOwed"></div>
                    </div>
                    <div class="tax-item highlight">
                        <div class="label" data-i18n="taxPaid">Tax Paid</div>
                        <div class="value" id="currentTaxPaid"></div>
                    </div>
                    <div class="tax-item highlight">
                        <div class="label" data-i18n="remainingTax">Remaining Tax</div>
                        <div class="value" id="currentRemainingTax"></div>
                    </div>
                    <div class="tax-item">
                        <div class="label" data-i18n="status">Status</div>
                        <div class="value" id="currentStatus"></div>
                    </div>
                </div>
                <div id="paymentSection" style="display: none;">
                    <h3 data-i18n="makePayment">Make Payment</h3>
                    <div class="payment-form">
                        <input type="number" id="paymentAmount" data-i18n-placeholder="enterPaymentAmount" placeholder="Enter amount to pay" min="0">
                        <button onclick="processPayment()" data-i18n="payNow">Pay Now</button>
                    </div>
                </div>
            </div>

            <div class="history">
                <h2 data-i18n="taxHistory">Tax History</h2>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th data-i18n="year">Year</th>
                            <th data-i18n="income">Income</th>
                            <th data-i18n="expenditure">Expenditure</th>
                            <th data-i18n="taxOwed">Tax Owed</th>
                            <th data-i18n="taxPaid">Tax Paid</th>
                            <th data-i18n="remainingTax">Remaining Tax</th>
                            <th data-i18n="status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="translations.js"></script>
    <script src="language-switcher.js"></script>
    <script>
        // Define more robust server URL detection with multiple fallbacks
        function getServerUrl() {
            // Log all available info for debugging
            console.log('Location info:', {
                hostname: window.location.hostname,
                origin: window.location.origin,
                href: window.location.href,
                protocol: window.location.protocol
            });
            
            // Try different approaches to get a working server URL
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('Using localhost URL');
                return 'http://localhost:5000';
            } else if (window.location.hostname.match(/^192\.168\./)) {
                console.log('Using local IP URL');
                return `http://${window.location.hostname}:5000`;
            } else if (window.location.hostname.match(/^172\.|^10\./)) {
                console.log('Using private network IP URL');
                return `http://${window.location.hostname}:5000`;
            } else if (window.location.hostname.includes('github.io') || 
                      window.location.hostname.includes('netlify') || 
                      window.location.hostname.includes('vercel.app') || 
                      /^(www\.)?[a-z0-9-]+\.(com|net|org|io)$/i.test(window.location.hostname)) {
                // For production internet facing deployments (master branch)
                console.log('Using production mock server URL');
                return 'http://34.173.20.218:5000';
            } else {
                // Use current origin as fallback
                console.log('Using origin as fallback URL');
                return window.location.origin;
            }
        }

        // Use the function to determine the server URL
        const MOCK_SERVER_URL = getServerUrl();
        let currentPhoneNumber = null;
        
        // Set default language to English
        if (!localStorage.getItem('taxAppLanguage')) {
            localStorage.setItem('taxAppLanguage', 'en');
        }
        
        // Initialize language selector with stored language or default to English
        document.addEventListener('DOMContentLoaded', function() {
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                const currentLang = localStorage.getItem('taxAppLanguage') || 'en';
                languageSelector.value = currentLang;
                currentLanguage = currentLang; // Set the global variable
                
                // Use the updateLanguage function to initialize
                updateLanguage(currentLang);
            }
            
            // Add translation for status text
            initializeStatusTranslations();
        });
        
        // Initialize translations for dynamic status texts
        function initializeStatusTranslations() {
            if (!translations.en.statusPending) {
                for (const lang in translations) {
                    // Add status translations
                    translations[lang].statusPending = translations[lang].statusPending || "pending";
                    translations[lang].statusPaid = translations[lang].statusPaid || "paid";
                    translations[lang].statusActive = translations[lang].statusActive || "active";
                    
                    // Add missing form translations
                    translations[lang].accountLogin = translations[lang].accountLogin || "Account Login";
                    translations[lang].enterPhoneNumber = translations[lang].enterPhoneNumber || "Enter your phone number";
                    translations[lang].or = translations[lang].or || "or";
                    translations[lang].createNewAccount = translations[lang].createNewAccount || "Create New Account";
                    translations[lang].registerNewAccount = translations[lang].registerNewAccount || "Register New Account";
                    translations[lang].tinLabel = translations[lang].tinLabel || "TIN (Tax Identification Number):";
                    translations[lang].enterTIN = translations[lang].enterTIN || "Enter your TIN";
                    translations[lang].register = translations[lang].register || "Register";
                    translations[lang].backToLogin = translations[lang].backToLogin || "Back to Login";
                    translations[lang].taxSummary = translations[lang].taxSummary || "Tax Summary";
                    translations[lang].currentYearSummary = translations[lang].currentYearSummary || "Current Year Summary";
                    translations[lang].totalTaxOwed = translations[lang].totalTaxOwed || "Total Tax Owed";
                    translations[lang].makePayment = translations[lang].makePayment || "Make Payment";
                    translations[lang].enterPaymentAmount = translations[lang].enterPaymentAmount || "Enter amount to pay";
                    translations[lang].payNow = translations[lang].payNow || "Pay Now";
                    translations[lang].taxHistory = translations[lang].taxHistory || "Tax History";
                    translations[lang].taxOwed = translations[lang].taxOwed || "Tax Owed";
                    translations[lang].logout = translations[lang].logout || "Logout";
                    translations[lang].login = translations[lang].login || "Login";
                    
                    // Add error message translations
                    translations[lang].userNotFound = translations[lang].userNotFound || "User not found";
                    translations[lang].networkError = translations[lang].networkError || "Network error";
                    translations[lang].connectionTimeout = translations[lang].connectionTimeout || "Connection timed out. Please try again";
                    translations[lang].failedLogin = translations[lang].failedLogin || "Failed to login";
                    translations[lang].failedLoadData = translations[lang].failedLoadData || "Failed to load account data";
                    translations[lang].enterValidPhone = translations[lang].enterValidPhone || "Please enter a valid phone number";
                    translations[lang].enterValidTIN = translations[lang].enterValidTIN || "Please enter a valid TIN";
                    translations[lang].regSuccess = translations[lang].regSuccess || "Registration successful";
                    translations[lang].regFailed = translations[lang].regFailed || "Registration failed";
                    translations[lang].enterValidAmount = translations[lang].enterValidAmount || "Please enter a valid amount";
                    translations[lang].paymentSuccess = translations[lang].paymentSuccess || "Payment successful";
                    translations[lang].paymentFailed = translations[lang].paymentFailed || "Payment failed";
                    translations[lang].failedPayment = translations[lang].failedPayment || "Failed to process payment";
                    translations[lang].wantToRegister = translations[lang].wantToRegister || "User not found. Would you like to register?";
                    translations[lang].serverError = translations[lang].serverError || "Server error";
                }
            }
        }

        // Nigerian tax calculation function
        function calculate_nigeria_tax(taxable_income) {
            const TAX_RATES = [
                { threshold: 300000, rate: 0.07 },  // First 300,000 at 7%
                { threshold: 300000, rate: 0.11 },  // Next 300,000 at 11%
                { threshold: 500000, rate: 0.15 },  // Next 500,000 at 15%
                { threshold: 500000, rate: 0.19 },  // Next 500,000 at 19%
                { threshold: 1600000, rate: 0.21 }, // Next 1,600,000 at 21%
                { threshold: 3200000, rate: 0.24 }  // Above 3,200,000 at 24%
            ];
            
            let tax = 0;
            let remaining_income = taxable_income;
            
            for (const { threshold, rate } of TAX_RATES) {
                if (remaining_income <= 0) break;
                const amount = Math.min(threshold, remaining_income);
                tax += amount * rate;
                remaining_income -= amount;
            }
            
            // Apply 24% for any amount above the last threshold
            if (remaining_income > 0) {
                tax += remaining_income * 0.24;
            }
            
            return tax;
        }

        async function login() {
            let phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            // Normalize phone number (remove spaces, dashes, etc.)
            phoneNumber = phoneNumber.replace(/[^0-9]/g, '');
            
            // Ensure phone number is in the right format
            if (!phoneNumber || !/^\d{10,}$/.test(phoneNumber)) {
                showLocalizedAlert('enterValidPhone');
                return;
            }

            // Store button original text in outer scope so it's available throughout the function
            let originalText = translations[currentLanguage].login || 'Login';
            
            try {
                console.log(`Attempting to login with phone: ${phoneNumber} to URL: ${MOCK_SERVER_URL}`);
                
                // Display loading state
                const loginButton = document.querySelector('#loginSection button');
                if (loginButton) {
                    originalText = loginButton.textContent; // Store the original text
                    loginButton.disabled = true;
                    loginButton.textContent = '...';
                    
                    // Re-enable after timeout (in case of network issues)
                    setTimeout(() => {
                        if (loginButton) {
                            loginButton.disabled = false;
                            loginButton.textContent = originalText;
                        }
                    }, 10000); // 10 seconds timeout
                }
                
                // Try multiple connection options if needed
                let response;
                let fetchOptions = {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache'
                    },
                    mode: 'cors'
                };
                
                console.log('Fetch options:', fetchOptions);
                
                // First try with all the options
                try {
                    console.log(`Attempting fetch with full options to ${MOCK_SERVER_URL}/admin/user/${phoneNumber}`);
                    const fetchPromise = fetch(`${MOCK_SERVER_URL}/admin/user/${phoneNumber}`, fetchOptions);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection timed out')), 15000)
                    );
                    response = await Promise.race([fetchPromise, timeoutPromise]);
                    console.log('Response received with status:', response.status);
                } catch (firstError) {
                    console.error('First fetch attempt failed:', firstError);
                    
                    // Try a simpler approach without CORS mode as fallback
                    try {
                        console.log('Retrying with simpler options...');
                        const simpleOptions = {
                            method: 'GET',
                            cache: 'no-cache'
                        };
                        console.log('Simple fetch options:', simpleOptions);
                        response = await fetch(`${MOCK_SERVER_URL}/admin/user/${phoneNumber}`, simpleOptions);
                        console.log('Fallback fetch succeeded with status:', response.status);
                    } catch (fallbackError) {
                        console.error('Both fetch attempts failed');
                        throw new Error(`Network error: ${fallbackError.message}`);
                    }
                }
                
                // Reset button state
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = originalText;
                }

                // Log response status for debugging
                console.log(`Login response status: ${response.status}, statusText: ${response.statusText}`);
                console.log('Response headers:', Array.from(response.headers.entries()));
                
                // Handle user not found - show registration option
                if (response.status === 404) {
                    showLocalizedAlert('userNotFound');
                    
                    // Ask if they want to register
                    if (confirm(translations[currentLanguage].wantToRegister || 'User not found. Would you like to register?')) {
                        showRegistrationForm();
                        const regPhoneNumberInput = document.getElementById('regPhoneNumber');
                        if (regPhoneNumberInput) regPhoneNumberInput.value = phoneNumber;
                    }
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                // Try to parse the response
                let data;
                try {
                    const responseText = await response.text();
                    
                    // Check if response is empty or not valid JSON
                    if (!responseText || responseText.trim() === '') {
                        console.error('Empty response received from server');
                        throw new Error('Empty response from server');
                    }
                    
                    console.log('Response text:', responseText.length > 100 ? 
                        responseText.substring(0, 100) + '...' : responseText); // Log first 100 chars
                        
                    try {
                        data = JSON.parse(responseText);
                        console.log('Parsed data:', data);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        
                        // Try to extract JSON from potential HTML wrapper
                        const jsonMatch = responseText.match(/(\{.*\})/s);
                        if (jsonMatch) {
                            console.log('Attempting to extract JSON from response');
                            try {
                                data = JSON.parse(jsonMatch[1]);
                                console.log('Successfully extracted JSON from response:', data);
                            } catch (extractError) {
                                console.error('Failed to extract JSON:', extractError);
                                throw new Error(`Failed to parse server response: ${parseError.message}`);
                            }
                        } else {
                            throw new Error(`Failed to parse server response: ${parseError.message}`);
                        }
                    }
                } catch (error) {
                    console.error('Response handling error:', error);
                    throw error;
                }

                if (data && data.status === 'success') {
                    currentPhoneNumber = phoneNumber;
                    const loginSection = document.getElementById('loginSection');
                    const accountSection = document.getElementById('accountSection');
                    
                    if (loginSection) loginSection.style.display = 'none';
                    if (accountSection) accountSection.style.display = 'block';
                    
                    // Update user info display
                    const userInfo = document.getElementById('userInfo');
                    if (userInfo) {
                        userInfo.textContent = phoneNumber;
                    }
                    
                    loadAccountData();
                } else {
                    throw new Error((data && data.message) || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Reset button state
                const loginButton = document.querySelector('#loginSection button');
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = originalText; // Use the stored original text
                }
                
                // Show appropriate error message
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showLocalizedAlert('networkError', ': ' + error.message);
                } else if (error.message.includes('timed out')) {
                    showLocalizedAlert('connectionTimeout');
                } else if (error.message.includes('parse') || error.message.includes('JSON')) {
                    showLocalizedAlert('serverError', ': Invalid response from server');
                } else if (error.message.includes('Empty response')) {
                    showLocalizedAlert('serverError', ': Server returned empty response');
                } else {
                    showLocalizedAlert('failedLogin', ': ' + error.message);
                }
            }
        }

        async function loadAccountData() {
            try {
                // Get selected year
                const yearSelector = document.getElementById('yearSelector');
                if (!yearSelector) {
                    console.error('Year selector element not found');
                    return;
                }
                const selectedYear = parseInt(yearSelector.value);
                console.log('Loading data for year:', selectedYear);
                
                // Fetch all tax history from CSV file via API - do this first so we have all data
                let allUserRecords = [];
                try {
                    console.log(`Fetching users data from ${MOCK_SERVER_URL}/admin/users`);
                    const csvResponse = await fetch(`${MOCK_SERVER_URL}/admin/users`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Cache-Control': 'no-cache'
                        },
                        credentials: 'include',
                        mode: 'cors'
                    });
                    
                    console.log('CSV response status:', csvResponse.status);
                    
                    if (!csvResponse.ok) {
                        throw new Error(`Failed to fetch user data: ${csvResponse.status}`);
                    }
                    
                    let allUsersData;
                    try {
                        const responseText = await csvResponse.text();
                        
                        // Check if response is empty
                        if (!responseText || responseText.trim() === '') {
                            console.error('Empty response received from server');
                            throw new Error('Empty response from server');
                        }
                        
                        console.log('Response text length:', responseText.length);
                        console.log('First 100 chars:', responseText.substring(0, 100));
                        
                        try {
                            allUsersData = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('JSON parse error:', parseError);
                            
                            // Try to extract JSON from potential HTML wrapper
                            const jsonMatch = responseText.match(/(\{.*\})/s);
                            if (jsonMatch) {
                                console.log('Attempting to extract JSON from response');
                                try {
                                    allUsersData = JSON.parse(jsonMatch[1]);
                                } catch (extractError) {
                                    console.error('Failed to extract JSON:', extractError);
                                    throw new Error(`Failed to parse server response: ${parseError.message}`);
                                }
                            } else {
                                throw new Error(`Failed to parse server response: ${parseError.message}`);
                            }
                        }
                        
                    } catch (parseError) {
                        console.error('Error parsing users data:', parseError);
                        throw parseError;
                    }
                    
                    console.log('All users data:', allUsersData);
                    
                    if (allUsersData && allUsersData.status === 'success' && allUsersData.data) {
                        // Filter records for the current phone number
                        allUserRecords = allUsersData.data.filter(record => 
                            record.phone_number === currentPhoneNumber
                        );
                        
                        // Sort records by year (descending)
                        allUserRecords.sort((a, b) => parseInt(b.tax_year) - parseInt(a.tax_year));
                        console.log('Filtered records for current user:', allUserRecords);
                    } else {
                        console.warn('No valid user records found in the response');
                    }
                } catch (csvError) {
                    console.error('Error fetching tax history:', csvError);
                    // Continue with other data loading, don't throw here
                }
                
                // Process and display all history records
                const tbody = document.getElementById('historyTableBody');
                if (!tbody) {
                    console.error('History table body element not found');
                    return;
                }
                tbody.innerHTML = '';
                
                // Find selected year record to display in summary section
                let selectedYearRecord = null;
                
                if (allUserRecords && allUserRecords.length > 0) {
                    for (const record of allUserRecords) {
                        const year = parseInt(record.tax_year);
                        const income = parseFloat(record.income || 0);
                        const expenses = parseFloat(record.expenditure || 0);
                        const taxPaid = parseFloat(record.tax_paid || 0);
                        
                        // Calculate taxable income and tax owed
                        const taxableIncome = Math.max(0, income - expenses);
                        const taxOwed = calculate_nigeria_tax(taxableIncome);
                        const remainingTax = Math.max(0, taxOwed - taxPaid);
                        
                        // Determine status
                        let status = record.status || 'pending';
                        if (taxPaid >= taxOwed) {
                            status = 'paid';
                        } else if (taxPaid > 0) {
                            status = 'active';
                        }
                        
                        // Translate status based on current language
                        const statusText = translations[currentLanguage][`status${status.charAt(0).toUpperCase() + status.slice(1)}`] || status;
                        
                        // Create row for history table
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${year}</td>
                            <td>₦${income.toLocaleString()}</td>
                            <td>₦${expenses.toLocaleString()}</td>
                            <td>₦${taxOwed.toLocaleString()}</td>
                            <td>₦${taxPaid.toLocaleString()}</td>
                            <td>₦${remainingTax.toLocaleString()}</td>
                            <td><span class="tax-status ${status}">${statusText}</span></td>
                        `;
                        tbody.appendChild(row);
                        
                        // If this is the selected year, save the record data
                        if (year === selectedYear) {
                            selectedYearRecord = {
                                year,
                                income,
                                expenses,
                                taxPaid,
                                taxableIncome,
                                taxOwed,
                                remainingTax,
                                status,
                                statusText
                            };
                        }
                    }
                } else {
                    console.warn('No tax records found for user:', currentPhoneNumber);
                }
                
                // Update the Tax Summary section with selected year data
                if (selectedYearRecord) {
                    console.log('Using selected year record from history:', selectedYearRecord);
                    updateTaxSummary(selectedYearRecord);
                } else {
                    // No data for selected year, make a fallback API call
                    try {
                        console.log(`Making fallback API call to ${MOCK_SERVER_URL}/tax/${currentPhoneNumber} for year ${selectedYear}`);
                        const response = await fetch(`${MOCK_SERVER_URL}/tax/${currentPhoneNumber}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'Cache-Control': 'no-cache'
                            },
                            credentials: 'include',
                            mode: 'cors',
                            body: JSON.stringify({
                                year: selectedYear
                            })
                        });

                        console.log('Fallback API response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }

                        let data;
                        try {
                            const responseText = await response.text();
                            
                            // Check if response is empty
                            if (!responseText || responseText.trim() === '') {
                                console.error('Empty response received from server');
                                throw new Error('Empty response from server');
                            }
                            
                            console.log('Response text length:', responseText.length);
                            console.log('First 100 chars:', responseText.substring(0, 100));
                            
                            try {
                                data = JSON.parse(responseText);
                            } catch (parseError) {
                                console.error('JSON parse error:', parseError);
                                
                                // Try to extract JSON from potential HTML wrapper
                                const jsonMatch = responseText.match(/(\{.*\})/s);
                                if (jsonMatch) {
                                    console.log('Attempting to extract JSON from response');
                                    try {
                                        data = JSON.parse(jsonMatch[1]);
                                    } catch (extractError) {
                                        console.error('Failed to extract JSON:', extractError);
                                        throw new Error(`Failed to parse server response: ${parseError.message}`);
                                    }
                                } else {
                                    throw new Error(`Failed to parse server response: ${parseError.message}`);
                                }
                            }
                        } catch (parseError) {
                            console.error('Error parsing tax data:', parseError);
                            throw parseError;
                        }

                        console.log('Server response:', data); // Debug log

                        if (data && data.status === 'success' && data.data) {
                            const taxData = data.data;
                            const income = parseFloat(taxData.income || 0);
                            const expenses = parseFloat(taxData.expenses || taxData.expenditure || 0);
                            
                            // Calculate taxable income
                            const taxableIncome = Math.max(0, income - expenses);
                            
                            // Calculate tax owed using the Nigerian tax rates
                            const taxOwed = calculate_nigeria_tax(taxableIncome);
                            
                            const taxPaid = parseFloat(taxData.tax_paid || 0);
                            const remainingTax = Math.max(0, taxOwed - taxPaid);
                            
                            // Update status based on tax paid vs tax owed
                            let status = 'pending';
                            if (taxPaid >= taxOwed) {
                                status = 'paid';
                            } else if (taxPaid > 0) {
                                status = 'active';
                            }

                            // Translate status based on current language
                            const statusText = translations[currentLanguage][`status${status.charAt(0).toUpperCase() + status.slice(1)}`] || status;
                            
                            // Create a record object
                            const record = {
                                year: selectedYear,
                                income: income,
                                expenses: expenses,
                                taxPaid: taxPaid,
                                taxableIncome: taxableIncome,
                                taxOwed: taxOwed,
                                remainingTax: remainingTax,
                                status: status,
                                statusText: statusText
                            };
                            
                            console.log('Created tax record from API response:', record);
                            updateTaxSummary(record);
                        } else {
                            console.error('Invalid response format:', data);
                            throw new Error('Invalid response from server');
                        }
                    } catch (taxError) {
                        console.error('Error fetching tax data:', taxError);
                        
                        // Create an empty record for the selected year to avoid null errors
                        const emptyRecord = {
                            year: selectedYear,
                            income: 0,
                            expenses: 0,
                            taxPaid: 0,
                            taxableIncome: 0,
                            taxOwed: 0,
                            remainingTax: 0,
                            status: 'pending',
                            statusText: translations[currentLanguage].statusPending || 'pending'
                        };
                        
                        console.log('Using empty tax record as fallback:', emptyRecord);
                        updateTaxSummary(emptyRecord);
                        
                        // Show error in tax summary section
                        const currentYearSummary = document.getElementById('currentYearSummary');
                        if (currentYearSummary) {
                            const errorMessage = document.createElement('div');
                            errorMessage.className = 'error-message';
                            errorMessage.textContent = translations[currentLanguage].failedLoadData || 'Failed to load tax data';
                            currentYearSummary.appendChild(errorMessage);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading account data:', error);
                showLocalizedAlert('failedLoadData', error.message);
            }
        }

        // Helper function to update the tax summary section
        function updateTaxSummary(record) {
            // Get all the elements we need to update, with null checks
            const currentYearEl = document.getElementById('currentYear');
            const currentIncomeEl = document.getElementById('currentIncome');
            const currentExpensesEl = document.getElementById('currentExpenses');
            const currentTaxOwedEl = document.getElementById('currentTaxOwed');
            const currentTaxPaidEl = document.getElementById('currentTaxPaid');
            const currentRemainingTaxEl = document.getElementById('currentRemainingTax');
            const currentStatusEl = document.getElementById('currentStatus');
            const paymentSectionEl = document.getElementById('paymentSection');
            
            // Only update elements that exist
            if (currentYearEl) currentYearEl.textContent = record.year;
            if (currentIncomeEl) currentIncomeEl.textContent = `₦${record.income.toLocaleString()}`;
            if (currentExpensesEl) currentExpensesEl.textContent = `₦${record.expenses.toLocaleString()}`;
            if (currentTaxOwedEl) currentTaxOwedEl.textContent = `₦${record.taxOwed.toLocaleString()}`;
            if (currentTaxPaidEl) currentTaxPaidEl.textContent = `₦${record.taxPaid.toLocaleString()}`;
            if (currentRemainingTaxEl) currentRemainingTaxEl.textContent = `₦${record.remainingTax.toLocaleString()}`;
            
            // Use the same translated status text and class as in the history table
            if (currentStatusEl) {
                currentStatusEl.textContent = record.statusText;
                currentStatusEl.className = `tax-status ${record.status}`;
            }

            // Show/hide payment section based on remaining tax
            if (paymentSectionEl) {
                paymentSectionEl.style.display = record.remainingTax > 0 ? 'block' : 'none';
            }
        }

        async function processPayment() {
            const paymentAmountInput = document.getElementById('paymentAmount');
            if (!paymentAmountInput) {
                console.error('Payment amount input not found');
                return;
            }
            
            const amount = parseFloat(paymentAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showLocalizedAlert('enterValidAmount');
                return;
            }

            // Show loading UI
            const payButton = document.querySelector('#paymentSection button');
            const originalButtonText = payButton ? payButton.textContent : '';
            
            if (payButton) {
                payButton.disabled = true;
                payButton.textContent = '...';
            }
            
            try {
                console.log(`Processing payment: ${amount} for user ${currentPhoneNumber}`);
                
                const yearSelector = document.getElementById('yearSelector');
                if (!yearSelector) {
                    console.error('Year selector not found');
                    throw new Error('Year selector not found');
                }
                
                const selectedYear = parseInt(yearSelector.value);
                console.log(`Selected year for payment: ${selectedYear}`);
                
                // Try multiple approaches for payment
                let response;
                
                // First try with full CORS and credentials
                try {
                    const fetchOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Cache-Control': 'no-cache'
                        },
                        credentials: 'include',
                        mode: 'cors',
                        body: JSON.stringify({
                            amount: amount,
                            year: selectedYear
                        })
                    };
                    
                    console.log('Full payment fetch options:', fetchOptions);
                    response = await fetch(`${MOCK_SERVER_URL}/pay-tax/${currentPhoneNumber}`, fetchOptions);
                    console.log('Payment response received with status:', response.status);
                } catch (firstError) {
                    console.error('First payment fetch attempt failed:', firstError);
                    
                    // Try simpler approach as fallback
                    try {
                        console.log('Retrying payment with simpler fetch options');
                        const simpleOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                amount: amount,
                                year: selectedYear
                            })
                        };
                        
                        response = await fetch(`${MOCK_SERVER_URL}/pay-tax/${currentPhoneNumber}`, simpleOptions);
                        console.log('Fallback payment fetch succeeded with status:', response.status);
                    } catch (fallbackError) {
                        console.error('Both payment fetch attempts failed');
                        throw new Error(`Network error: ${fallbackError.message}`);
                    }
                }

                if (!response.ok) {
                    console.error(`Error payment response: ${response.status} ${response.statusText}`);
                    throw new Error(translations[currentLanguage].paymentFailed);
                }

                // Safely parse the response
                let data;
                try {
                    const responseText = await response.text();
                    console.log('Payment response text length:', responseText.length);
                    
                    // Check if response is empty
                    if (!responseText || responseText.trim() === '') {
                        console.error('Empty response received from payment server');
                        throw new Error('Empty response from server');
                    }
                    
                    console.log('Payment response text:', responseText.length > 100 ? 
                        responseText.substring(0, 100) + '...' : responseText);
                        
                    try {
                        data = JSON.parse(responseText);
                        console.log('Parsed payment data:', data);
                    } catch (parseError) {
                        console.error('Payment JSON parse error:', parseError);
                        
                        // Try to extract JSON from potential HTML wrapper
                        const jsonMatch = responseText.match(/(\{.*\})/s);
                        if (jsonMatch) {
                            console.log('Attempting to extract JSON from payment response');
                            try {
                                data = JSON.parse(jsonMatch[1]);
                                console.log('Successfully extracted JSON from payment response:', data);
                            } catch (extractError) {
                                console.error('Failed to extract payment JSON:', extractError);
                                throw new Error(`Failed to parse server response: ${parseError.message}`);
                            }
                        } else {
                            throw new Error(`Failed to parse server response: ${parseError.message}`);
                        }
                    }
                } catch (error) {
                    console.error('Payment response handling error:', error);
                    throw error;
                }
                
                if (data && data.status === 'success') {
                    // Refresh account data to show updated values
                    await loadAccountData();
                    
                    // Clear payment amount with null check
                    if (paymentAmountInput) paymentAmountInput.value = '';
                    
                    showLocalizedAlert('paymentSuccess');
                } else {
                    throw new Error((data && data.message) || translations[currentLanguage].paymentFailed);
                }
            } catch (error) {
                console.error('Error processing payment:', error);
                
                // Show appropriate error message based on error type
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showLocalizedAlert('networkError', ': ' + error.message);
                } else if (error.message.includes('timed out')) {
                    showLocalizedAlert('connectionTimeout');
                } else if (error.message.includes('parse') || error.message.includes('JSON')) {
                    showLocalizedAlert('serverError', ': Invalid response from server');
                } else if (error.message.includes('Empty response')) {
                    showLocalizedAlert('serverError', ': Server returned empty response');
                } else {
                    showLocalizedAlert('failedPayment', ': ' + error.message);
                }
            } finally {
                // Reset button state regardless of success/failure
                if (payButton) {
                    payButton.disabled = false;
                    payButton.textContent = originalButtonText;
                }
            }
        }

        function logout() {
            currentPhoneNumber = null;
            
            // Show login section, hide account section
            const loginSection = document.getElementById('loginSection');
            const accountSection = document.getElementById('accountSection');
            
            if (loginSection) loginSection.style.display = 'block';
            if (accountSection) accountSection.style.display = 'none';
            
            // Clear login form
            const phoneNumberInput = document.getElementById('phoneNumber');
            if (phoneNumberInput) phoneNumberInput.value = '';
            
            // Clear all data displays with null checks
            const currentYearSummary = document.getElementById('currentYearSummary');
            const historyTableBody = document.getElementById('historyTableBody');
            const userInfo = document.getElementById('userInfo');
            
            if (currentYearSummary) currentYearSummary.innerHTML = '';
            if (historyTableBody) historyTableBody.innerHTML = '';
            if (userInfo) userInfo.innerHTML = '';
            
            // Hide payment section and clear payment amount
            const paymentSection = document.getElementById('paymentSection');
            const paymentAmount = document.getElementById('paymentAmount');
            
            if (paymentSection) {
                paymentSection.style.display = 'none';
                
                // Remove any success/error messages with null checks
                const successMessage = paymentSection.querySelector('.success-message');
                const errorMessage = paymentSection.querySelector('.error-message');
                
                if (successMessage) successMessage.remove();
                if (errorMessage) errorMessage.remove();
            }
            
            if (paymentAmount) paymentAmount.value = '';
        }

        function showRegistrationForm() {
            const loginSection = document.getElementById('loginSection');
            const registrationSection = document.getElementById('registrationSection');
            
            if (loginSection) loginSection.style.display = 'none';
            if (registrationSection) registrationSection.style.display = 'block';
        }

        function showLoginForm() {
            const loginSection = document.getElementById('loginSection');
            const registrationSection = document.getElementById('registrationSection');
            
            if (loginSection) loginSection.style.display = 'block';
            if (registrationSection) registrationSection.style.display = 'none';
        }

        async function register() {
            const regPhoneNumberInput = document.getElementById('regPhoneNumber');
            const regTINInput = document.getElementById('regTIN');
            
            if (!regPhoneNumberInput || !regTINInput) {
                console.error('Registration form elements not found');
                return;
            }
            
            const phoneNumber = regPhoneNumberInput.value.trim();
            const tin = regTINInput.value.trim();

            if (!phoneNumber || !/^\d{10,}$/.test(phoneNumber)) {
                showLocalizedAlert('enterValidPhone');
                return;
            }

            if (!tin || tin.length < 6) {
                showLocalizedAlert('enterValidTIN');
                return;
            }

            try {
                const response = await fetch(`${MOCK_SERVER_URL}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        message: `REG ${tin}`
                    })
                });

                if (!response.ok) throw new Error(translations[currentLanguage].regFailed);

                const data = await response.json();
                if (data.status === 'success') {
                    showLocalizedAlert('regSuccess');
                    showLoginForm();
                    
                    // Set the phone number in the login form with null check
                    const phoneNumberInput = document.getElementById('phoneNumber');
                    if (phoneNumberInput) phoneNumberInput.value = phoneNumber;
                } else {
                    throw new Error(data.message || translations[currentLanguage].regFailed);
                }
            } catch (error) {
                showLocalizedAlert('regFailed', error.message);
            }
        }

        // Function to show an alert in the current language
        function showLocalizedAlert(key, additionalText = '') {
            const lang = localStorage.getItem('taxAppLanguage') || 'en';
            let message = translations[lang][key] || translations['en'][key];
            if (additionalText) {
                message += additionalText;
            }
            alert(message);
        }

        // Update language function to refresh both Tax Summary and Tax History sections
        function updateLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('taxAppLanguage', lang);
            
            // Update all i18n elements
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });
            
            // Refresh tax data to update status text with new language
            if (currentPhoneNumber) {
                loadAccountData();
            }
        }
    </script>
</body>
</html> 