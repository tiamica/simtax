<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <title data-i18n="mobileSimulator">Tax App Mobile Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .simulator-container {
            width: 360px;
            height: 640px;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background-color: #007bff;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .app-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-section {
            padding: 1.5rem;
            background-color: white;
            border-bottom: 1px solid #eee;
        }

        .login-section.logged-in {
            background-color: #e8f4ff;
            color: #007bff;
            text-align: center;
            font-weight: 500;
        }

        .command-section {
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .response-section {
            flex: 1;
            padding: 1rem;
            background-color: white;
            overflow-y: auto;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message-sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message-received {
            background-color: #f0f2f5;
            color: #1c1e21;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus {
            border-color: #007bff;
        }

        button {
            width: 100%;
            padding: 0.8rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 0.5rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        .command-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .command-input-container input {
            flex: 1;
        }

        .command-input-container button {
            width: auto;
            padding: 0.8rem 1.2rem;
            margin-top: 0;
        }

        .help-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
            text-align: center;
        }

        .status-bar {
            background-color: #0056b3;
            color: white;
            padding: 0.3rem;
            font-size: 0.8rem;
            text-align: center;
        }

        .logout-btn {
            width: 50%;
            padding: 0.8rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 0.5rem;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .header-logo {
            height: 40px;
            margin-right: 1rem;
            vertical-align: middle;
        }

        .app-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }

        .app-header img {
            height: 40px;
            margin-right: 1rem;
        }

        .app-header h1 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }

        /* Additional styles for language selector in simulator */
        .language-selector-container {
            padding: 0.5rem;
            background-color: #f8f9fa;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .language-selector-container label {
            margin-right: 0.5rem;
            font-size: 0.9rem;
            color: #333;
        }
        
        .language-selector {
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="simulator-container">
        <div class="status-bar">
            <span id="currentTime">12:00</span>
            <span>üì± 4G</span>
            <span>üîã 100%</span>
        </div>
        <div class="app-header">
            <img src="Fourier-Analytics-Logo.png" alt="Fourier Analytics Logo">
            <h1 data-i18n="taxApp">Tax App</h1>
            <button onclick="logout()" class="logout-btn" id="logoutBtn" style="display: none;">Logout</button>
        </div>
        
        <!-- Language selector -->
        <div class="language-selector-container">
            <label for="languageSelector" data-i18n="language">Language:</label>
            <select id="languageSelector" class="language-selector">
                <option value="en" data-i18n="english">English</option>
                <option value="ig" data-i18n="igbo">Igbo</option>
                <option value="yo" data-i18n="yoruba">Yoruba</option>
                <option value="ha" data-i18n="hausa">Hausa</option>
            </select>
        </div>
        
        <div id="loginSection" class="login-section">
            <input type="text" id="phoneNumber" data-i18n-placeholder="phoneNumberPlaceholder" placeholder="Enter your phone number">
            <button onclick="login()" data-i18n="login">Login</button>
            <div class="help-text" data-i18n="loginHelp">Enter your phone number to access your tax account</div>
        </div>
        
        <div id="loggedInSection" class="login-section logged-in" style="display: none;">
            <span data-i18n="loggedInAs">Logged in as:</span> <span id="loggedInPhoneNumber"></span>
            <button class="logout-btn" onclick="logout()" data-i18n="logout">Logout</button>
        </div>
        
        <div class="response-section" id="responseContainer">
            <div class="message-bubble message-received" data-i18n="welcomeMessage">
                Welcome to the Tax App. Please log in to access your account, or type HELP for assistance.
            </div>
        </div>
        
        <div class="command-section">
            <div class="command-input-container">
                <input type="text" id="commandInput" data-i18n-placeholder="enterCommand" placeholder="Enter a command">
                <button onclick="sendCommand()" data-i18n="send">Send</button>
            </div>
            <div class="help-text" data-i18n="commandHelp">Type 'HELP' for a list of available commands</div>
        </div>
    </div>

    <script src="translations.js"></script>
    <script src="language-switcher.js"></script>
    <script>
        // Define more robust server URL detection with multiple fallbacks
        function getServerUrl() {
            // Log all available info for debugging
            console.log('Location info:', {
                hostname: window.location.hostname,
                origin: window.location.origin,
                href: window.location.href,
                protocol: window.location.protocol
            });
            
            // Try different approaches to get a working server URL
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('Using localhost URL');
                return 'http://localhost:5000';
            } else if (window.location.hostname.match(/^192\.168\./)) {
                console.log('Using local IP URL');
                return `http://${window.location.hostname}:5000`;
            } else if (window.location.hostname.match(/^172\.|^10\./)) {
                console.log('Using private network IP URL');
                return `http://${window.location.hostname}:5000`;
            } else if (window.location.hostname.includes('github.io') || 
                      window.location.hostname.includes('netlify') || 
                      window.location.hostname.includes('vercel.app') || 
                      /^(www\.)?[a-z0-9-]+\.(com|net|org|io)$/i.test(window.location.hostname)) {
                // For production internet facing deployments (master branch)
                console.log('Using production mock server URL');
                return 'http://34.173.20.218:5000';
            } else {
                // Use current origin as fallback
                console.log('Using origin as fallback URL');
                return window.location.origin;
            }
        }

        // Use the function to determine the server URL
        const MOCK_SERVER_URL = getServerUrl();
        let currentPhoneNumber = null;
        let currentTaxYear = new Date().getFullYear(); // Track the current tax year

        // Update status bar time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Initialize event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Add keyboard event listener for command input
            document.getElementById('commandInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendCommand();
                }
            });

            // Add keyboard event listener for phone number input
            document.getElementById('phoneNumber').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                }
            });
        });

        function addMessage(message, isSent = false, msgId = null) {
            const chatContainer = document.getElementById('responseContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
            
            // Add ID if provided for potential removal later
            if (msgId) {
                messageDiv.id = `msg-${msgId}`;
            }
            
            // Handle both string messages and message objects
            if (typeof message === 'object' && message !== null) {
                messageDiv.textContent = message.message || JSON.stringify(message);
            } else {
                messageDiv.textContent = message;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeMessage(msgId) {
            const message = document.getElementById(`msg-${msgId}`);
            if (message) {
                message.remove();
            }
        }

        function logout() {
            currentPhoneNumber = null;
            currentTaxYear = new Date().getFullYear(); // Reset tax year to current year
            
            // Reset login section
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('loginSection').innerHTML = `
                <input type="text" id="phoneNumber" placeholder="Enter phone number (e.g., 2348012345678)">
                <button onclick="login()">Login</button>
            `;
            
            // Hide logout button
            document.getElementById('logoutBtn').style.display = 'none';
            
            // Clear phone number input
            document.getElementById('phoneNumber').value = '';
            
            // Disable command input
            document.getElementById('commandInput').disabled = true;
            document.getElementById('commandInput').value = '';
            
            // Reset chat container to welcome message
            const chatContainer = document.getElementById('responseContainer');
            chatContainer.innerHTML = '<div class="message-received">Welcome to Tax App! Please login with your phone number to continue.</div>';
        }

        // Nigerian tax calculation function
        function calculate_nigeria_tax(taxable_income) {
            const TAX_RATES = [
                { threshold: 300000, rate: 0.07 },  // First 300,000 at 7%
                { threshold: 300000, rate: 0.11 },  // Next 300,000 at 11%
                { threshold: 500000, rate: 0.15 },  // Next 500,000 at 15%
                { threshold: 500000, rate: 0.19 },  // Next 500,000 at 19%
                { threshold: 1600000, rate: 0.21 }, // Next 1,600,000 at 21%
                { threshold: 3200000, rate: 0.24 }  // Above 3,200,000 at 24%
            ];
            
            let tax = 0;
            let remaining_income = taxable_income;
            
            for (const { threshold, rate } of TAX_RATES) {
                if (remaining_income <= 0) break;
                const amount = Math.min(threshold, remaining_income);
                tax += amount * rate;
                remaining_income -= amount;
            }
            
            // Apply 24% for any amount above the last threshold
            if (remaining_income > 0) {
                tax += remaining_income * 0.24;
            }
            
            return tax;
        }

        async function login() {
            let phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            // Normalize phone number (remove spaces, dashes, etc.)
            phoneNumber = phoneNumber.replace(/[^0-9]/g, '');
            
            // Ensure phone number is in the right format
            if (!phoneNumber || !/^\d{10,}$/.test(phoneNumber)) {
                addMessage('Please enter a valid phone number');
                return;
            }

            // Store button text and references outside try/catch for access throughout the function
            const loginButton = document.querySelector('#loginSection button');
            let originalButtonText = 'Login';
            
            if (loginButton) {
                originalButtonText = loginButton.textContent;
                loginButton.disabled = true;
                loginButton.textContent = '...';
            }

            try {
                // Show loading state
                addMessage('Logging in...');
                console.log(`Attempting to login with phone: ${phoneNumber} to URL: ${MOCK_SERVER_URL}`);
                
                // First try with all options including credentials and CORS
                let response;
                let fetchOptions = {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache'
                    },
                    mode: 'cors'
                };
                
                console.log('Initial fetch options:', fetchOptions);
                
                try {
                    // Create a timeout promise
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection timed out')), 15000)
                    );
                    
                    // Attempt the fetch with timeout
                    console.log(`Attempting fetch with full options to ${MOCK_SERVER_URL}/admin/user/${phoneNumber}`);
                    response = await Promise.race([
                        fetch(`${MOCK_SERVER_URL}/admin/user/${phoneNumber}`, fetchOptions),
                        timeoutPromise
                    ]);
                    console.log('Response received with status:', response.status);
                } catch (firstError) {
                    console.error('First fetch attempt failed:', firstError);
                    
                    // Try a simpler approach as fallback
                    try {
                        console.log('Retrying with simpler options...');
                        const simpleOptions = {
                            method: 'GET',
                            cache: 'no-cache'
                        };
                        console.log('Simple fetch options:', simpleOptions);
                        response = await fetch(`${MOCK_SERVER_URL}/admin/user/${phoneNumber}`, simpleOptions);
                        console.log('Fallback fetch succeeded with status:', response.status);
                    } catch (fallbackError) {
                        console.error('Both fetch attempts failed');
                        throw new Error(`Network error: ${fallbackError.message}`);
                    }
                }
                
                // Reset button state
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = originalButtonText;
                }
                
                console.log(`Login response status: ${response.status}, statusText: ${response.statusText}`);
                console.log('Response headers:', Array.from(response.headers.entries()));
                
                if (response.status === 404) {
                    // User not found, show registration message
                    currentPhoneNumber = phoneNumber;
                    document.getElementById('loginSection').innerHTML = 
                        `<div class="logged-in">Phone number: ${phoneNumber}</div>`;
                    document.getElementById('commandInput').disabled = false;
                    document.getElementById('logoutBtn').style.display = 'block';
                    addMessage(`Welcome! Please register using the REG command followed by your TIN number (e.g., REG TIN123456)`);
                    addMessage(`Current tax year is set to: ${currentTaxYear}. Use YEAR command to change it.`);
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                // Safely parse the response
                let data;
                try {
                    const responseText = await response.text();
                    console.log('Response text length:', responseText.length);
                    
                    // Check if response is empty
                    if (!responseText || responseText.trim() === '') {
                        console.error('Empty response received from server');
                        throw new Error('Empty response from server');
                    }
                    
                    console.log('Response text:', responseText.length > 100 ? 
                        responseText.substring(0, 100) + '...' : responseText);
                        
                    try {
                        data = JSON.parse(responseText);
                        console.log('Parsed data:', data);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        
                        // Try to extract JSON from potential HTML wrapper
                        const jsonMatch = responseText.match(/(\{.*\})/s);
                        if (jsonMatch) {
                            console.log('Attempting to extract JSON from response');
                            try {
                                data = JSON.parse(jsonMatch[1]);
                                console.log('Successfully extracted JSON from response:', data);
                            } catch (extractError) {
                                console.error('Failed to extract JSON:', extractError);
                                throw new Error(`Failed to parse server response: ${parseError.message}`);
                            }
                        } else {
                            throw new Error(`Failed to parse server response: ${parseError.message}`);
                        }
                    }
                } catch (error) {
                    console.error('Response handling error:', error);
                    throw error;
                }
                
                if (data && data.status === 'success') {
                    currentPhoneNumber = phoneNumber;
                    document.getElementById('loginSection').innerHTML = 
                        `<div class="logged-in">Logged in as ${phoneNumber}</div>`;
                    document.getElementById('commandInput').disabled = false;
                    document.getElementById('logoutBtn').style.display = 'block';
                    addMessage(`Welcome back ${phoneNumber}! You can now use the available commands.`);
                    addMessage(`Current tax year is set to: ${currentTaxYear}. Use YEAR command to change it.`);
                } else {
                    throw new Error((data && data.message) || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                addMessage(`Error: ${error.message}`);
                
                // Reset button state if login section still exists and hasn't been replaced
                const loginSection = document.getElementById('loginSection');
                if (loginSection && loginButton && !loginSection.querySelector('.logged-in')) {
                    loginButton.disabled = false;
                    loginButton.textContent = originalButtonText;
                }
                
                // Clear any "logging in" message
                const loggedInSection = document.getElementById('loggedInSection');
                if (loggedInSection) {
                    loggedInSection.style.display = 'none';
                }
            }
        }

        async function sendCommand() {
            const commandInput = document.getElementById('commandInput');
            const command = commandInput.value.trim();
            if (!command) return;

            // Add command to the chat
            addMessage(command, true);
            commandInput.value = '';

            // Special case for HELP command - always available even if not logged in
            if (command.toUpperCase() === 'HELP') {
                const lang = localStorage.getItem('taxAppLanguage') || 'en';
                const helpText = {
                    'en': 'Available commands:\n- REG TIN123456: Register with TIN\n- INC 5000: Add income\n- EXP 2000: Add expenditure\n- YEAR 2023: Set tax year\n- TAX: View tax calculation\n- RETURN: Check tax return status\n- PAY 1000: Make tax payment',
                    'ig': 'Iwu d·ªã:\n- REG TIN123456: Debanye aha na TIN\n- INC 5000: Tinye ego ·ªã na-enweta\n- EXP 2000: Tinye ego ·ªã na-emefu\n- YEAR 2023: H·ªçr·ªç af·ªç ·ª•t·ª• isi\n- TAX: Lelee ·ªçn·ª• ·ªçg·ª•g·ª• ·ª•t·ª• isi\n- RETURN: Lelee ·ªçn·ªçd·ª• nlele ·ª•t·ª• isi\n- PAY 1000: Kw·ª•·ªç ·ª•t·ª• isi',
                    'yo': 'Aw·ªçn a·π£·∫π to wa:\n- REG TIN123456: Foruk·ªçsil·∫π p·∫πlu TIN\n- INC 5000: Fi owo sii\n- EXP 2000: Fi owo gbigba sii\n- YEAR 2023: Yan odun owo ori\n- TAX: Wo i·π£iro owo ori\n- RETURN: ·π¢ay·∫πwo ipo ipadab·ªç owo ori\n- PAY 1000: San owo ori',
                    'ha': 'Umarnin da ke akwai:\n- REG TIN123456: Yi rajista da TIN\n- INC 5000: ∆òara ku…ói shigowa\n- EXP 2000: ∆òara ku…ói fitarwa\n- YEAR 2023: Za…ìi shekara na haraji\n- TAX: Duba lissafin haraji\n- RETURN: Duba matsayin dawowar haraji\n- PAY 1000: Biyan haraji'
                }[lang];
                
                addMessage(helpText);
                return;
            }

            if (!currentPhoneNumber) {
                const lang = localStorage.getItem('taxAppLanguage') || 'en';
                const loginPrompt = {
                    'en': 'Please login first to use commands.',
                    'ig': 'Biko banye iji jiri iwu.',
                    'yo': 'J·ªçw·ªç w·ªçle lati lo aw·ªçn a·π£·∫π.',
                    'ha': 'Da fatan za a shiga don amfani da umarni.'
                }[lang];
                
                addMessage(loginPrompt);
                return;
            }

            // Add loading indicator
            const loadingMsgId = Date.now().toString();
            addMessage('Processing command...', false, loadingMsgId);

            try {
                const [cmd, ...args] = command.split(' ');
                let response;

                switch(cmd.toUpperCase()) {
                    case 'REG':
                        response = await sendMessage(currentPhoneNumber, command);
                        break;
                    case 'INC':
                    case 'EXP':
                        // Append the year to the command if not already specified
                        if (args.length === 1) {
                            response = await sendMessage(currentPhoneNumber, `${cmd} ${args[0]} ${currentTaxYear}`);
                        } else {
                            response = await sendMessage(currentPhoneNumber, command);
                        }
                        break;
                    case 'YEAR':
                        response = await handleYearCommand(args[0]);
                        break;
                    case 'TAX':
                        response = await handleTaxCommand(currentPhoneNumber, args[0] || currentTaxYear);
                        break;
                    case 'RETURN':
                        response = await handleReturnCommand(currentPhoneNumber, args[0] || currentTaxYear);
                        break;
                    case 'PAY':
                        if (!args[0]) {
                            throw new Error('Payment amount required');
                        }
                        response = await handlePayCommand(currentPhoneNumber, args[0], args[1] || currentTaxYear);
                        break;
                    default:
                        throw new Error('Invalid command');
                }

                // Remove loading message
                removeMessage(loadingMsgId);
                
                // Show response
                addMessage(formatResponse(response));
            } catch (error) {
                console.error('Command error:', error);
                
                // Remove loading message
                removeMessage(loadingMsgId);
                
                // Show error message
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    addMessage(`Error: Network error - ${error.message}`);
                } else if (error.message.includes('timed out')) {
                    addMessage('Error: Connection timed out. Please try again.');
                } else if (error.message.includes('parse') || error.message.includes('JSON')) {
                    addMessage('Error: Invalid response from server. Please try again.');
                } else if (error.message.includes('Empty response')) {
                    addMessage('Error: Server returned empty response. Please try again.');
                } else {
                    addMessage(`Error: ${error.message}`);
                }
            }
        }

        async function sendMessage(phoneNumber, message) {
            try {
                const response = await fetch(`${MOCK_SERVER_URL}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        message: message
                    })
                });

                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to send message');
                    } catch (parseError) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                }

                // Safely parse the response
                let data;
                try {
                    const responseText = await response.text();
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('Invalid response from server. Please try again.');
                }
                
                // If this was a successful registration, update the UI
                if (message.toUpperCase().startsWith('REG') && data.status === 'success') {
                    document.getElementById('loginSection').innerHTML = 
                        `<div class="logged-in">Logged in as ${phoneNumber}</div>`;
                    addMessage('Registration successful! You can now use other commands.');
                }

                return data;
            } catch (error) {
                console.error('Send message error:', error);
                throw error;
            }
        }

        async function handleYearCommand(yearArg) {
            if (!yearArg) {
                return {
                    status: 'success',
                    message: `Current tax year is set to: ${currentTaxYear}`
                };
            }

            const year = parseInt(yearArg);
            const currentYear = new Date().getFullYear();
            
            // Validate that the year is reasonable (not too far in the past or future)
            if (isNaN(year) || year < 2019 || year > currentYear + 1) {
                throw new Error(`Invalid year. Please enter a year between 2019 and ${currentYear + 1}`);
            }
            
            // Update the current tax year
            currentTaxYear = year;
            
            return {
                status: 'success',
                message: `Tax year successfully set to: ${year}`
            };
        }

        async function handleTaxCommand(phoneNumber, year) {
            try {
                console.log(`Fetching tax data for ${phoneNumber}, year: ${year}`);
                
                // Try multiple approaches to connect to server
                let response;
                
                // First try with full CORS and credentials
                try {
                    const fetchOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Cache-Control': 'no-cache'
                        },
                        credentials: 'include',
                        mode: 'cors',
                        body: JSON.stringify({
                            year: year || currentTaxYear
                        })
                    };
                    
                    console.log('Full fetch options:', fetchOptions);
                    response = await fetch(`${MOCK_SERVER_URL}/tax/${phoneNumber}`, fetchOptions);
                    console.log('Response received with status:', response.status);
                } catch (firstError) {
                    console.error('First fetch attempt failed:', firstError);
                    
                    // Try simpler approach as fallback
                    try {
                        console.log('Retrying with simpler fetch options');
                        const simpleOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                year: year || currentTaxYear
                            })
                        };
                        
                        response = await fetch(`${MOCK_SERVER_URL}/tax/${phoneNumber}`, simpleOptions);
                        console.log('Fallback fetch succeeded with status:', response.status);
                    } catch (fallbackError) {
                        console.error('Both fetch attempts failed');
                        throw new Error(`Network error: ${fallbackError.message}`);
                    }
                }

                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    // Try to read error message
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Failed with status: ${response.status}`);
                    } catch (parseError) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                }

                // Safely parse the response
                let responseData;
                try {
                    const responseText = await response.text();
                    console.log('Response text length:', responseText.length);
                    
                    // Check if response is empty
                    if (!responseText || responseText.trim() === '') {
                        console.error('Empty response received from server');
                        throw new Error('Empty response from server');
                    }
                    
                    console.log('Response text:', responseText.length > 100 ? 
                        responseText.substring(0, 100) + '...' : responseText);
                        
                    try {
                        responseData = JSON.parse(responseText);
                        console.log('Parsed data:', responseData);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        
                        // Try to extract JSON from potential HTML wrapper
                        const jsonMatch = responseText.match(/(\{.*\})/s);
                        if (jsonMatch) {
                            console.log('Attempting to extract JSON from response');
                            try {
                                responseData = JSON.parse(jsonMatch[1]);
                                console.log('Successfully extracted JSON from response:', responseData);
                            } catch (extractError) {
                                console.error('Failed to extract JSON:', extractError);
                                throw new Error(`Failed to parse server response: ${parseError.message}`);
                            }
                        } else {
                            throw new Error(`Failed to parse server response: ${parseError.message}`);
                        }
                    }
                } catch (error) {
                    console.error('Response handling error:', error);
                    throw error;
                }
                
                // Ensure we have tax_owed calculated correctly
                if (responseData && responseData.status === 'success' && responseData.data) {
                    const data = responseData.data;
                    const income = parseFloat(data.income || 0);
                    const expenses = parseFloat(data.expenses || data.expenditure || 0);
                    const taxable_income = Math.max(0, income - expenses);
                    
                    // Calculate tax owed if not already in the response
                    if (!data.tax_owed) {
                        data.tax_owed = calculate_nigeria_tax(taxable_income);
                    }
                } else {
                    throw new Error('Invalid or incomplete data received from server');
                }

                return responseData;
            } catch (error) {
                console.error('Tax command error:', error);
                throw error;
            }
        }

        async function handleReturnCommand(phoneNumber, year) {
            try {
                const response = await fetch(`${MOCK_SERVER_URL}/return/${phoneNumber}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        year: year || currentTaxYear
                    })
                });

                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Failed with status: ${response.status}`);
                    } catch (parseError) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                }

                // Safely parse the response
                try {
                    const responseText = await response.text();
                    return JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('Invalid response from server. Please try again.');
                }
            } catch (error) {
                console.error('Return command error:', error);
                throw error;
            }
        }

        async function handlePayCommand(phoneNumber, amount, year) {
            try {
                const response = await fetch(`${MOCK_SERVER_URL}/pay-tax/${phoneNumber}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        year: year || currentTaxYear
                    })
                });

                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Failed with status: ${response.status}`);
                    } catch (parseError) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                }

                // Safely parse the response
                try {
                    const responseText = await response.text();
                    return JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('Invalid response from server. Please try again.');
                }
            } catch (error) {
                console.error('Pay command error:', error);
                throw error;
            }
        }

        function formatResponse(response) {
            if (response.status === 'success') {
                if (response.message) {
                    // For simple message responses (like INC and EXP), detect and format those to include year
                    if (response.message.includes('Income of ‚Ç¶') || response.message.includes('Expense of ‚Ç¶')) {
                        return `${response.message} (Tax Year: ${currentTaxYear})`;
                    }
                    return response.message;
                }
                if (response.data) {
                    const data = response.data;
                    if (data.income !== undefined) {
                        const taxOwed = parseFloat(data.tax_owed || 0);
                        const taxPaid = parseFloat(data.tax_paid || 0);
                        const remainingTax = Math.max(0, taxOwed - taxPaid);
                        
                        // Calculate status based on tax paid vs tax owed
                        let status = 'pending';
                        if (taxPaid >= taxOwed && taxOwed > 0) {
                            status = 'paid';
                        } else if (taxPaid > 0) {
                            status = 'active';
                        }
                        
                        return `Tax Year: ${data.year || currentTaxYear}
Income: ‚Ç¶${parseFloat(data.income).toLocaleString()}
Expenses: ‚Ç¶${parseFloat(data.expenses || data.expenditure || 0).toLocaleString()}
Total Tax Owed: ‚Ç¶${taxOwed.toLocaleString()}
${data.tax_paid ? `Tax Paid: ‚Ç¶${taxPaid.toLocaleString()}` : ''}
Remaining Tax: ‚Ç¶${remainingTax.toLocaleString()}
Status: ${status}`;
                    }
                    if (data.amount_paid !== undefined) {
                        return `Payment Processed:
Tax Year: ${data.year || currentTaxYear}
Amount Paid: ‚Ç¶${parseFloat(data.amount_paid).toLocaleString()}
Total Paid: ‚Ç¶${parseFloat(data.total_paid).toLocaleString()}
Total Tax: ‚Ç¶${parseFloat(data.total_tax).toLocaleString()}
Remaining Tax: ‚Ç¶${parseFloat(data.remaining_tax).toLocaleString()}
Status: ${data.status}`;
                    }
                }
                return JSON.stringify(response.data, null, 2);
            }
            return `Error: ${response.error || 'Unknown error'}`;
        }

        async function processMessage(phoneNumber, message) {
            try {
                const response = await fetch(`${MOCK_SERVER_URL}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        message: message
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // Update the display with the new tax information
                    const taxInfo = data.data;
                    const taxOwed = parseFloat(taxInfo.tax_owed || 0);
                    const taxPaid = parseFloat(taxInfo.tax_paid || 0);
                    const remainingTax = Math.max(0, taxOwed - taxPaid);
                    
                    // Update the status based on the new values
                    let status = 'pending';
                    if (taxPaid >= taxOwed) {
                        status = 'paid';
                    } else if (taxPaid > 0) {
                        status = 'active';
                    }
                    
                    // Update the display
                    document.getElementById('taxOwed').textContent = `‚Ç¶${taxOwed.toLocaleString()}`;
                    document.getElementById('taxPaid').textContent = `‚Ç¶${taxPaid.toLocaleString()}`;
                    document.getElementById('remainingTax').textContent = `‚Ç¶${remainingTax.toLocaleString()}`;
                    document.getElementById('taxStatus').textContent = status;
                    document.getElementById('taxStatus').className = `status-badge status-${status}`;
                    
                    // Show/hide payment section based on remaining tax
                    const paymentSection = document.getElementById('paymentSection');
                    paymentSection.style.display = remainingTax > 0 ? 'block' : 'none';
                }
                
                return data;
            } catch (error) {
                console.error('Error processing message:', error);
                return {
                    status: 'error',
                    message: 'Failed to process message'
                };
            }
        }

        // Update language selector to handle changes
        document.getElementById('languageSelector').addEventListener('change', function() {
            const lang = this.value;
            updateLanguage(lang);
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Apply the stored language or default to English
            const lang = localStorage.getItem('taxAppLanguage') || 'en';
            document.getElementById('languageSelector').value = lang;
            
            // Apply translations
            updateLanguage(lang);
            
            // Setup a function to show localized alerts
            window.showLocalizedAlert = function(key, additionalText = '') {
                const lang = localStorage.getItem('taxAppLanguage') || 'en';
                let message = translations[lang][key] || translations['en'][key];
                if (additionalText) {
                    message += additionalText;
                }
                alert(message);
            };
        });
    </script>
</body>
</html> 